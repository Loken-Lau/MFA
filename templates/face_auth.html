{% extends "base.html" %}
{% block content %}
<h2 class="text-xl font-bold text-center mb-4">{{ "第一步：录入人脸凭证" if mode == 'register' else "第二步：刷脸签署挑战码" }}</h2>
<video id="video" autoplay muted class="w-full rounded shadow-inner mb-4"></video>
<div id="msg" class="text-center text-blue-600 mb-4 font-mono text-sm">正在初始化摄像头...</div>
<button id="snap" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">点击识别</button>

<script>
    const video = document.getElementById('video');
    const msg = document.getElementById('msg');
    navigator.mediaDevices.getUserMedia({ video: true }).then(s => {
        video.srcObject = s;
        msg.innerText = "摄像头已就绪";
    });

    document.getElementById('snap').onclick = async () => {
        msg.innerText = "处理中，请稍后...";
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        const resp = await fetch(window.location.href, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ image: canvas.toDataURL('image/jpeg') })
        });
        const res = await resp.json();
        if(res.status === 'success') {
            msg.innerText = "认证成功！";
            window.location.href = res.next;
        } else {
            msg.innerText = "错误: " + res.message;
        }
    };
</script>
{% endblock %}